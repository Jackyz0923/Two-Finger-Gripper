#include <stdio.h>
#include "gripper_algo.h"

int main()
{
    float dt = 0.001;

    float ratio = 1.0;     // 速度比例 100%
    
    float home_theta = 0;  // 零位时的关节角度

    // 逆运动学
    float current_dis = 0;
    printf("current_dis = %f\n", current_dis);
    printf("current_theta: %f\n", gripper_ikine(home_theta, current_dis));

    current_dis = 60;
    printf("current_dis = %f\n", current_dis);
    printf("current_theta: %f\n", gripper_ikine(home_theta, current_dis));

    // 正运动学
    float current_theta = gripper_ikine(home_theta, current_dis);
    printf("current_theta = %f\n", current_theta);
    printf("current_dis: %f\n", gripper_kine(home_theta, current_theta));

    // 轨迹规划
    current_dis = 0;
    float target_dis = 65;
    ratio = 1.0;
    Trajectory traj = gripper_traj_planning(dt, home_theta, MAX_VEL*ratio, current_dis, target_dis);

    printf("t_total = %f\n", traj.t_sum);

    FILE *fp = fopen("traj.txt", "w");

    float q = 0, dq = 0;
    while(1)
    {
        int ret = gripper_traj_run(&traj, &q, &dq);
        fprintf(fp, "%f, %f, %f, %f\n",traj.t, q, dq, gripper_kine(home_theta, q));
        if(ret != 0)
        {
            break;
        }
    }
    fclose(fp);

    
    // current_theta = 2.9645;
    current_theta = gripper_ikine(home_theta, 5.98466);
    float current_vel = 77.0;
    Trajectory traj_stop = gripper_emergency_stop_traj_planning(dt, home_theta, current_theta, current_vel);
    FILE *fp2 = fopen("traj_stop.txt", "w");
    while(1)
    {
        int ret = gripper_emergency_stop_traj_run(&traj_stop, &q, &dq);
        fprintf(fp2, "%f, %f, %f\n",traj_stop.t, q, dq);
        if(ret != 0)
        {
            break;
        }
    }
    fclose(fp2);


    float curr[501] = {0, 0.221458930006357, 0.266580895298614, 0.157815905898738, 0.0576224215548180, 0.0439533636705194, 0.0302773650405736, -0.0699369404442632, -0.178736628092428, -0.133663232676573, 0.0877332634950129, 0.309115905567257, 0.354147740872808, 0.245278793666202, 0.144967540111673, 0.131166920210007, 0.117345587531106, 0.0169721989156545, -0.0920002958237114, -0.0471134041714028, 0.174082921015398, 0.395251756490938, 0.440056183350406, 0.330946261758767, 0.230380505932904, 0.216311896062463, 0.202209128036067, 0.101540903136307, -0.00773978226611605, 0.0368256130112654, 0.257687186879274, 0.478508068953271, 0.522951395274320, 0.413467283029347, 0.312514305524278, 0.298045504095551, 0.283529637826673, 0.182435473233239, 0.0727160739467635, 0.116830050427723, 0.337227571871200, 0.557571841171815, 0.601526069633310, 0.491540451676837, 0.390073639801886, 0.375078756485298, 0.360024643885009, 0.258380153511948, 0.148098435900451, 0.191638190307578, 0.411449676604732, 0.631196190228274, 0.674541036874501, 0.563934507193017, 0.461835351732470, 0.446196792824083, 0.430487774269632, 0.328177250997286, 0.217218478715698, 0.260070263596708, 0.479182974150081, 0.698220016156974, 0.740844807347473, 0.629507752076283, 0.526667716250514, 0.510278039194988, 0.493807783321742, 0.390726023767144, 0.278986138026994, 0.321047055620004, 0.539359269943055, 0.757586313184927, 0.799391730983911, 0.687226057083269, 0.583548288238593, 0.566311896062463, 0.548986076673050, 0.445040040310115, 0.332427300948791, 0.373606925941490, 0.591029547851410, 0.808358839344295, 0.849258487823834, 0.736179170064768, 0.631580027097647, 0.613414676030705, 0.595152459675488, 0.490262736139696, 0.376699168417607, 0.416920974008448, 0.633378936726213, 0.849736881567507, 0.889658649322921, 0.775595071185892, 0.670005443613100, 0.650843540121776, 0.631578860890649, 0.525680922327928, 0.411103546636727, 0.450306111408311, 0.665739561406609, 0.881067883410660, 0.919955080800441, 0.804852148140042, 0.698218546012270, 0.678008212790042, 0.657690814211292, 0.550736032920822, 0.435097858009458, 0.473235834580963, 0.687601075510084, 0.901857736258456, 0.939669989433786, 0.823488999346323, 0.715774396816635, 0.694480290920135, 0.673076518535027, 0.565032933857127, 0.448303697911942, 0.485348528094421, 0.698618709899789, 0.911778571712222, 0.948492459336690, 0.831211710528095, 0.722396129771651, 0.700000000000000, 0.677493332113692, 0.568346154468525, 0.450512802360135, 0.486453167536202, 0.698618709899792, 0.910673932270441, 0.946283354888498, 0.827898489916694, 0.717979316192985, 0.694480290920134, 0.670871599158675, 0.560623443286756, 0.441690332457229, 0.476532332082435, 0.687601075510086, 0.898561238756986, 0.933077514986013, 0.813601588980386, 0.702593611869250, 0.678008212790042, 0.653315748354314, 0.541986592080478, 0.421975423823885, 0.455742479234640, 0.665739561406609, 0.875631515584329, 0.909083203613283, 0.788546478387495, 0.676481658548607, 0.650843540121776, 0.625102645955142, 0.512729515126326, 0.391678992346364, 0.424411477391489, 0.633378936726212, 0.842246378184470, 0.874678825394162, 0.753128292199263, 0.640055257333446, 0.613414676030704, 0.586677229439688, 0.473313614005200, 0.351278830847277, 0.383033435168277, 0.591029547851412, 0.798932330117511, 0.830406957925346, 0.707905596369679, 0.593888874331006, 0.566311896062463, 0.538645490580635, 0.424360501023702, 0.301412074007356, 0.332260909008905, 0.539359269943051, 0.746372459796024, 0.776965795003551, 0.653591579826713, 0.538710580979702, 0.510278039194988, 0.481764918592555, 0.366642196016715, 0.242865150370917, 0.272894611980953, 0.479182974150083, 0.685395667772728, 0.715198135692253, 0.591042807056853, 0.475390571927590, 0.446196792824083, 0.416932554074510, 0.301068951133448, 0.176561379897945, 0.205870786052254, 0.411449676604735, 0.616963594483600, 0.646078092877007, 0.521245709571514, 0.404927441542967, 0.375078756485298, 0.345170842143926, 0.228674895617267, 0.103546412656752, 0.132246436995794, 0.337227571871202, 0.542155454603744, 0.570695730923319, 0.445301029292810, 0.328432435484634, 0.298045504095551, 0.267611507866320, 0.150601726969781, 0.0249717382977635, 0.0531826647772521, 0.257687186879278, 0.462151017187288, 0.490239874710438, 0.364406459195876, 0.247111925694027, 0.216311896062463, 0.185477708274945, 0.0680807056991987, -0.0579234736261514, -0.0300736476850794, 0.174082921015405, 0.378212000004622, 0.405979361152845, 0.279837754975222, 0.162248385189064, 0.131166920210007, 0.100064742453713, -0.0175867623933677, -0.143831916103750, -0.116209498608759, 0.0877332634950108, 0.291662171499447, 0.319243028884128, 0.192928615615303, 0.0751801626985316, 0.0439533636705195, 0.0127196238968608, -0.105049650160827, -0.231398761677941, -0.203866474169664, 4.78602620686009e-16, 0.203866474169664, 0.231398761677941, 0.105049650160827, -0.0127196238968608, -0.0439533636705193, -0.0751801626985316, -0.192928615615303, -0.319243028884128, -0.291662171499446, -0.0877332634950099, 0.116209498608766, 0.143831916103747, 0.0175867623933608, -0.100064742453716, -0.131166920210007, -0.162248385189064, -0.279837754975223, -0.405979361152846, -0.378212000004615, -0.174082921015393, 0.0300736476850863, 0.0579234736261482, -0.0680807056992056, -0.185477708274945, -0.216311896062463, -0.247111925694027, -0.364406459195877, -0.490239874710442, -0.462151017187282, -0.257687186879266, -0.0531826647772452, -0.0249717382977666, -0.150601726969788, -0.267611507866321, -0.298045504095551, -0.328432435484634, -0.445301029292810, -0.570695730923322, -0.542155454603738, -0.337227571871189, -0.132246436995787, -0.103546412656752, -0.228674895617267, -0.345170842143926, -0.375078756485298, -0.404927441542967, -0.521245709571514, -0.646078092877007, -0.616963594483596, -0.411449676604728, -0.205870786052257, -0.176561379897944, -0.301068951133448, -0.416932554074510, -0.446196792824083, -0.475390571927590, -0.591042807056853, -0.715198135692255, -0.685395667772725, -0.479182974150077, -0.272894611980956, -0.242865150370916, -0.366642196016715, -0.481764918592556, -0.510278039194988, -0.538710580979701, -0.653591579826713, -0.776965795003552, -0.746372459796020, -0.539359269943056, -0.332260909008908, -0.301412074007355, -0.424360501023702, -0.538645490580635, -0.566311896062463, -0.593888874331006, -0.707905596369680, -0.830406957925343, -0.798932330117516, -0.591029547851422, -0.383033435168280, -0.351278830847276, -0.473313614005197, -0.586677229439687, -0.613414676030704, -0.640055257333445, -0.753128292199257, -0.874678825394160, -0.842246378184476, -0.633378936726223, -0.424411477391491, -0.391678992346363, -0.512729515126323, -0.625102645955140, -0.650843540121776, -0.676481658548607, -0.788546478387489, -0.909083203613281, -0.875631515584335, -0.665739561406614, -0.455742479234643, -0.421975423823884, -0.541986592080476, -0.653315748354312, -0.678008212790042, -0.702593611869249, -0.813601588980383, -0.933077514986012, -0.898561238756986, -0.687601075510086, -0.476532332082435, -0.441690332457229, -0.560623443286757, -0.670871599158677, -0.694480290920134, -0.717979316192984, -0.827898489916691, -0.946283354888498, -0.910673932270441, -0.698618709899791, -0.486453167536202, -0.450512802360135, -0.568346154468528, -0.677493332113693, -0.700000000000000, -0.722396129771650, -0.831211710528092, -0.948492459336690, -0.911778571712222, -0.698618709899788, -0.485348528094418, -0.448303697911944, -0.565032933857130, -0.673076518535029, -0.694480290920135, -0.715774396816635, -0.823488999346324, -0.939669989433786, -0.901857736258452, -0.687601075510077, -0.473235834580959, -0.435097858009459, -0.550736032920826, -0.657690814211295, -0.678008212790042, -0.698218546012271, -0.804852148140045, -0.919955080800442, -0.881067883410657, -0.665739561406600, -0.450306111408306, -0.411103546636730, -0.525680922327935, -0.631578860890649, -0.650843540121776, -0.670005443613101, -0.775595071185896, -0.889658649322922, -0.849736881567509, -0.633378936726204, -0.416920974008449, -0.376699168417610, -0.490262736139700, -0.595152459675487, -0.613414676030705, -0.631580027097646, -0.736179170064760, -0.849258487823834, -0.808358839344301, -0.591029547851409, -0.373606925941494, -0.332427300948792, -0.445040040310113, -0.548986076673051, -0.566311896062463, -0.583548288238590, -0.687226057083268, -0.799391730983909, -0.757586313184925, -0.539359269943060, -0.321047055620000, -0.278986138026994, -0.390726023767149, -0.493807783321742, -0.510278039194988, -0.526667716250514, -0.629507752076278, -0.740844807347474, -0.698220016156977, -0.479182974150075, -0.260070263596709, -0.217218478715701, -0.328177250997286, -0.430487774269635, -0.446196792824083, -0.461835351732468, -0.563934507193021, -0.674541036874501, -0.631196190228269, -0.411449676604733, -0.191638190307571, -0.148098435900452, -0.258380153511956, -0.360024643885010, -0.375078756485297, -0.390073639801888, -0.491540451676836, -0.601526069633313, -0.557571841171814, -0.337227571871188, -0.116830050427721, -0.0727160739467672, -0.182435473233242, -0.283529637826673, -0.298045504095551, -0.312514305524278, -0.413467283029341, -0.522951395274321, -0.478508068953276, -0.257687186879271, -0.0368256130112693, 0.00773978226611975, -0.101540903136306, -0.202209128036064, -0.216311896062463, -0.230380505932901, -0.330946261758769, -0.440056183350404, -0.395251756490935, -0.174082921015403, 0.0471134041713942, 0.0920002958237114, -0.0169721989156484, -0.117345587531106, -0.131166920210007, -0.144967540111673, -0.245278793666199, -0.354147740872810, -0.309115905567259, -0.0877332634950038, 0.133663232676572, 0.178736628092430, 0.0699369404442619, -0.0302773650405717, -0.0439533636705193, -0.0576224215548172, -0.157815905898742, -0.266580895298614, -0.221458930006351, 6.14304137610759e-16};

    filter_st curr_filter;

    // 滤波器初始化
    utils_filter_init(&curr_filter);
    
    // 滤波器设计
    utils_second_order_lowpass_filter_design(dt, 10.0, 0.75, &curr_filter);

    FILE *fp3 = fopen("cur.txt", "w");
    for(int i = 0; i < 501; i++)
    {
        float curr_f = utils_second_order_filter(curr[i], &curr_filter);
        fprintf(fp3,"%f,%f\n", curr[i], curr_f);
    }
    fclose(fp3);
     

    return 0;
}